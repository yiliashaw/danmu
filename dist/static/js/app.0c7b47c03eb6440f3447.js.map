{"version":3,"sources":["webpack:///src/components/Message.vue","webpack:///./src/components/Message.vue?b623","webpack:///./src/components/Message.vue","webpack:///./src/danmu-dom/message.js","webpack:///./src/danmu-dom/track.js","webpack:///src/App.vue","webpack:///./src/danmu-dom/manager.js","webpack:///./src/App.vue?1f25","webpack:///./src/App.vue","webpack:///./src/main.js"],"names":["components_Message","props","content","type","String","duration","Number","fontSize","data","mounted","selectortype_template_index_0_src_components_Message","render","_h","this","$createElement","_self","_c","staticClass","style","animation-duration","_v","_s","staticRenderFns","src_components_Message","__webpack_require__","normalizeComponent","ssrContext","INIT","Message","_ref","_ref$id","id","undefined","_ref$content","_ref$fontSize","_ref$duration","_ref$windowWidth","windowWidth","_ref$owner","owner","classCallCheck_default","startTime","endTime","speed","width","left","state","parent","init","length","Date","now","console","log","Track","top","children","offsetFromX","child","push","start","index","indexOf","splice","_this","forEach","isExpired","removeChild","App_manager","Manager","possibleConstructorReturn_default","__proto__","get_prototype_of_default","call","pending","tracks","currentID","find","track","canAddChild","every","lastChild","map","reduce","a","c","message","getIdleTrack","addChild","emit","cur","nextID","danmu_dom_message","addMessage","unshift","_this2","removeAllChildren","_this3","garbageCollect","item","consumePending","i","App","components","randomDanmu","list","danmuData","queue","to","pushTimer","methods","Math","floor","random","add","addMessageMultiple","count","cleanDanmu","cleanAll","clearTimeout","updateDanmu","getData","e","afterLeave","el","leave","on","setTimeout","tick","selectortype_template_index_0_src_App","_vm","attrs","staticStyle","display","click","$event","_l","key","name","after-leave","ref","refInFor","src_App","App_normalizeComponent","vue_esm","config","productionTip","template"],"mappings":"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","file":"static/js/app.0c7b47c03eb6440f3447.js","sourcesContent":["<template>\n  <div\n    class=\"text\"\n    :style=\"{\n      'animation-duration': duration/1000 + 's',\n      fontSize: fontSize + 'px',\n    }\"\n  >\n    {{content}}\n  </div>\n</template>\n\n<script>\nexport default {\n  props: {\n    content: {\n      type: String\n    },\n    duration: {\n      type: Number\n    },\n    fontSize: {\n      type: Number\n    }\n  },\n  data() {\n    return {};\n  },\n  mounted() {}\n};\n</script>\n\n<style scoped>\n.text {\n  position: absolute;\n  /* width: 100%; */\n  /* padding-left: 50px; */\n  /* background: pink; */\n  text-align: left;\n  top: 50%;\n  left: 100%;\n  white-space: nowrap;\n  transform: translateX(0);\n  /* transition: transform 1s linear; */\n  font-size: 26px;\n  animation: moveLeft 5s linear;\n  background: rgba(255, 255, 255, 8);\n  padding: 5px 15px;\n  border-radius: 50px;\n  color: #232323;\n}\n\n@keyframes moveLeft {\n  0% {\n    transform: translateX(0);\n  }\n\n  100% {\n    transform: translateX(-1800px);\n  }\n}\n</style>\n\n\n\n\n// WEBPACK FOOTER //\n// src/components/Message.vue","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{staticClass:\"text\",style:({\n    'animation-duration': _vm.duration/1000 + 's',\n    fontSize: _vm.fontSize + 'px',\n  })},[_vm._v(\"\\n  \"+_vm._s(_vm.content)+\"\\n\")])}\nvar staticRenderFns = []\nvar esExports = { render: render, staticRenderFns: staticRenderFns }\nexport default esExports\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/vue-loader/lib/template-compiler?{\"id\":\"data-v-b2c141f8\",\"hasScoped\":true,\"transformToRequire\":{\"video\":[\"src\",\"poster\"],\"source\":\"src\",\"img\":\"src\",\"image\":\"xlink:href\"},\"buble\":{\"transforms\":{}}}!./node_modules/vue-loader/lib/selector.js?type=template&index=0!./src/components/Message.vue\n// module id = null\n// module chunks = ","function injectStyle (ssrContext) {\n  require(\"!!../../node_modules/extract-text-webpack-plugin/dist/loader.js?{\\\"omit\\\":1,\\\"remove\\\":true}!vue-style-loader!css-loader?{\\\"sourceMap\\\":true}!../../node_modules/vue-loader/lib/style-compiler/index?{\\\"vue\\\":true,\\\"id\\\":\\\"data-v-b2c141f8\\\",\\\"scoped\\\":true,\\\"hasInlineConfig\\\":false}!../../node_modules/vue-loader/lib/selector?type=styles&index=0!./Message.vue\")\n}\nvar normalizeComponent = require(\"!../../node_modules/vue-loader/lib/component-normalizer\")\n/* script */\nexport * from \"!!babel-loader!../../node_modules/vue-loader/lib/selector?type=script&index=0!./Message.vue\"\nimport __vue_script__ from \"!!babel-loader!../../node_modules/vue-loader/lib/selector?type=script&index=0!./Message.vue\"\n/* template */\nimport __vue_template__ from \"!!../../node_modules/vue-loader/lib/template-compiler/index?{\\\"id\\\":\\\"data-v-b2c141f8\\\",\\\"hasScoped\\\":true,\\\"transformToRequire\\\":{\\\"video\\\":[\\\"src\\\",\\\"poster\\\"],\\\"source\\\":\\\"src\\\",\\\"img\\\":\\\"src\\\",\\\"image\\\":\\\"xlink:href\\\"},\\\"buble\\\":{\\\"transforms\\\":{}}}!../../node_modules/vue-loader/lib/selector?type=template&index=0!./Message.vue\"\n/* template functional */\nvar __vue_template_functional__ = false\n/* styles */\nvar __vue_styles__ = injectStyle\n/* scopeId */\nvar __vue_scopeId__ = \"data-v-b2c141f8\"\n/* moduleIdentifier (server only) */\nvar __vue_module_identifier__ = null\nvar Component = normalizeComponent(\n  __vue_script__,\n  __vue_template__,\n  __vue_template_functional__,\n  __vue_styles__,\n  __vue_scopeId__,\n  __vue_module_identifier__\n)\n\nexport default Component.exports\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/components/Message.vue\n// module id = null\n// module chunks = ","\nconst INIT = 0;\nconst START = 1;\nconst ANIMATE = 2\nconst END = 3;\n\n\nexport default class Message {\n  constructor({\n    id = 0,\n    content = '',\n    fontSize = 36, // px\n    duration = 5 * 1000, // 5s\n    windowWidth = 750,\n    owner = false,\n  }) {\n    this.id = id;\n    this.content = content;\n    this.fontSize = fontSize;\n    this.duration = duration;\n    this.windowWidth = windowWidth;\n    this.owner = owner;\n    this.startTime =  null;\n    this.endTime = null;\n    this.speed = 0;\n    this.width = 0;\n    this.left = 100;\n    this.state = INIT;\n    this.parent = null;\n    this.init();\n  }\n\n  init() {\n    this.width = this.content.length * this.fontSize;\n    this.speed = this.windowWidth / this.duration;  // px/s\n    // this.state = START;\n  }\n\n  start() {\n    this.state = START;\n    this.startTime = Date.now();\n    this.endTime = this.startTime + this.duration;\n    console.log('开始动--》', this.id, this.endTime-this.startTime, this.width,this.windowWidth);\n  }\n\n  isExpired() {\n    return this.state === START &&\n      Date.now() > this.endTime;\n  }\n\n  offsetFromX() {\n    const now = Date.now();\n    const passed = now - this.startTime;\n    const moved = passed * this.speed;\n    return moved - this.width;\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/danmu-dom/message.js","export default class Track {\n  constructor({\n    id,\n    top\n  }) {\n    this.id = id;\n    this.top = top;\n    this.children = [];\n  }\n\n  canAddChild() {\n    if (this.children && this.children.length <= 0) {\n      return true;\n    }\n\n    const lastChild = this.children[this.children.length - 1];\n    if (lastChild.offsetFromX() > 2) {\n      return true;\n    }\n\n    return false;\n  }\n\n  addChild(child) {\n    this.children.push(child);\n    child.top = this.top;\n    // child.parent = this;\n    child.start();\n  }\n\n  removeChild(child) {\n    const index = this.children.indexOf(child);\n    this.children.splice(index, 1);\n    // child.parent = null;\n  }\n\n  lastChild() {\n    return this.children[this.children.length - 1];\n  }\n\n  removeAllChildren() {\n    this.children.splice(0, this.children.length);\n  }\n\n  garbageCollect() {\n    this.children.forEach(child => {\n      if (child.isExpired()) {\n        console.log('垃圾回收--》', child.id, child.startTime, Date.now());\n        this.removeChild(child);\n      }\n    });\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/danmu-dom/track.js","<template>\n  <div id=\"app\">\n    <div class=\"action\" style=\"display:flex\">\n    <div class=\"add\" @click=\"addMessageMultiple(15)\">{{message}}</div>\n    <div class=\"add\" @click=\"cleanDanmu\">清除弹幕</div>\n\n    </div>\n      <div class=\"wrap\">\n          <div class=\"track\" v-for=\"item in danmuData\" :key=\"item.id\">\n            <transition-group name=\"left\" v-on:leave=\"leave\" v-on:after-leave=\"afterLeave\">\n              <div class=\"text\" v-for=\"message in item.children\" :key=\"message.id\" ref=\"messages\"\n              :style=\"{\n                'animation-duration': message.duration/1000 + 's',\n                fontSize: message.fontSize + 'px',\n              }\">\n              {{message.content}}\n              </div>\n             </transition-group>\n          </div>\n      </div>\n  </div>\n</template>\n\n<script>\nimport Message from './components/Message';\nimport Manager from './danmu-dom/manager';\nconst manager = new Manager();\nconst fontSize = 18;\nconst windowWidth = 750;\nconst duration = 8000;\n\nexport default {\n  components: {\n    Message\n  },\n  data() {\n    return {\n      message: '发送弹幕',\n      randomDanmu: [\n        '哦',\n        '你好',\n        '我很好',\n        '所以你呢',\n        '我也非常好',\n        '那我知道了哦',\n        '可是我还不知道',\n        '那你怎么才能知道',\n        '这是一个字数递增的',\n        '这是一个字数递增的句子',\n        '这是一个字数递增的句子啊',\n        '这是一个字数递增的句子你好',\n        '这是一个字数递增的句子我很好',\n        '这是一个字数递增的句子你还好吗',\n        '这是一个字数递增的句子我也非常好',\n        '这是一个字数递增的句子这是一个字数递增的句子'\n      ],\n      list: [],\n      danmuData: [],\n      queue: [],\n      to: null,\n      pushTimer: null\n    };\n  },\n\n  methods: {\n    addMessage() {\n      const { length } = this.randomDanmu;\n      const content = this.randomDanmu[Math.floor(Math.random() * length + 0)];\n      console.log('push-->');\n      // this.queue.push(content);\n      manager.add({\n        content,\n        fontSize,\n        duration\n      });\n    },\n\n    addMessageMultiple(count) {\n      for (let i = 0; i < count; ++i) {\n        this.addMessage();\n      }\n    },\n\n    cleanDanmu() {\n      manager.cleanAll();\n      clearTimeout(this.to);\n    },\n\n    updateDanmu() {\n      this.danmuData = manager.getData();\n      // this.$nextTick(() => {\n      //   this.$refs.messages &&\n      //     this.$refs.messages.forEach(message => {\n      //       console.dir(message);\n\n      //       message.addEventListener('animationend', e => {\n      //         console.log(\n      //           'animation end',\n      //           e.target.innerText,\n      //           e.target.dataset.message,\n      //           e.target.dataset.track\n      //         );\n      //       });\n      //     });\n      // });\n    },\n\n    garbageCollect(message, track, e) {\n      // console.log('message', message.id, track.id, message, track, e);\n      // manager.gc(message, track);\n    },\n    afterLeave(el) {\n      console.log('after leave');\n    },\n    leave(el) {\n      console.log('leave');\n    }\n  },\n\n  mounted() {\n    // this.addMessageMultiple(5);\n\n    // console.log('ref', this.$refs);\n\n    this.updateDanmu();\n    manager.on('update', this.updateDanmu);\n\n    let to, pushTimer;\n    const tickInterval = 20;\n\n    const tick = () => {\n      manager.tick();\n\n      this.to = setTimeout(tick, tickInterval);\n    };\n    this.to = setTimeout(tick, tickInterval);\n  }\n};\n</script>\n\n<style>\n* {\n  margin: 0;\n  padding: 0;\n}\n#app {\n  font-family: 'Avenir', Helvetica, Arial, sans-serif;\n  -webkit-font-smoothing: antialiased;\n  -moz-osx-font-smoothing: grayscale;\n  text-align: center;\n  color: #2c3e50;\n  margin-top: 60px;\n}\n\n.add {\n  width: 100px;\n  height: 40px;\n  line-height: 40px;\n  text-align: center;\n  margin-bottom: 50px;\n  margin-left: 50px;\n  background: transparent;\n  border: 2px solid #2c3e50;\n  border-radius: 5px;\n}\n\n.add:hover {\n  cursor: pointer;\n}\n\n.wrap {\n  width: 750px;\n  height: 300px;\n  background: #555555;\n  position: relative;\n}\n\n.wrap .track {\n  position: relative;\n  width: 100%;\n  height: 30px;\n  margin-bottom: 20px;\n  color: #ffffff;\n}\n\n.text {\n  position: absolute;\n  text-align: left;\n  top: 50%;\n  left: 100%;\n  white-space: nowrap;\n  transform: translateX(0);\n  font-size: 18px;\n  background: rgba(255, 255, 255, 8);\n  padding: 5px 15px;\n  border-radius: 50px;\n  color: #555555;\n  /* animation-fill-mode: forwards; */\n}\n.left-enter-active {\n  animation: moveLeft 5s linear;\n}\n\n@keyframes moveLeft {\n  0% {\n    transform: translateX(0);\n  }\n\n  100% {\n    transform: translateX(-1800px);\n  }\n}\n</style>\n\n\n\n// WEBPACK FOOTER //\n// src/App.vue","import Message from './message';\nimport Track from './track';\nimport EventEmitter from 'eventemitter3';\n\nconst MAX_TRACKS = 5;\nconst MAX_MESSAGE_COUNT = 20;\nconst BASE_TOP = 50;\n\nexport default class Manager extends EventEmitter {\n  constructor(id) {\n    super();\n\n    this.pending = [];\n    this.tracks = [];\n    this.init();\n    this.currentID = 0;\n  }\n\n  getIdleTrack() {\n    return this.tracks.find(track => track.canAddChild())\n  }\n\n  isWindowClear() {\n    return this.tracks.every(track => {\n      const lastChild = track.lastChild();\n      if (lastChild) {\n        return lastChild.isExpired()\n      }\n      return true;\n    });\n  }\n\n  totalMessageCount() {\n    return this.tracks.map(track => track.children.length).reduce((a, c) => a + c);\n  }\n\n  addMessage(message) {\n\n    const track = this.getIdleTrack();\n    if (track) {\n      // if (this.totalMessageCount() >= MAX_MESSAGE_COUNT && this.isWindowClear()) {\n      //   this.garbageCollect();\n      //   return false;\n      // } else if (this.totalMessageCount() >= MAX_MESSAGE_COUNT) {\n      //   return false;\n      // }\n      console.log('add:', message.id);\n      track.addChild(message);\n      // if (track === this.tracks[0])\n      // console.log(track.children.map((a, i) => [a.id, a.startTime - (track.children[i - 1] ? track.children[i - 1].startTime : 0)]));\n      this.emit('update');\n\n\n\n      return true;\n    }\n\n    return false;\n  }\n\n  nextID() {\n    const cur = this.currentID + 1;\n\n    this.currentID = cur;\n\n    return cur;\n  }\n\n  add({\n    content,\n    fontSize,\n    duration,\n    windowWidth,\n    owner,\n  }) {\n    const id = this.nextID();\n    const message = new Message({\n      id,\n      content: `${content}:${id}`,\n      fontSize,\n      duration,\n      windowWidth,\n      owner\n    });\n\n    if (!this.addMessage(message)) {\n      console.log('pending:', message.id);\n      if (message.owner) {\n        this.pending.unshift(message);\n      } else {\n        this.pending.push(message);\n      }\n\n    }\n  }\n\n  consumePending() {\n    const pending = [];\n    this.pending.forEach(message => {\n      if (!this.addMessage(message)) {\n        pending.push(message);\n      }\n    });\n    this.pending = pending;\n  }\n\n  getData() {\n    return this.tracks;\n  }\n\n  cleanAll() {\n    this.pending = [];\n    this.tracks.forEach(track => {\n      track.removeAllChildren();\n    });\n\n    this.emit('update');\n  }\n\n  garbageCollect() {\n    this.tracks.forEach(track => {\n      track.garbageCollect();\n      this.emit('update');\n    });\n  }\n\n  gc(message, track) {\n    this.tracks.find(item => item === track).removeChild(message);\n    this.emit('update');\n  }\n\n  tick() {\n    this.garbageCollect();\n    // console.log('windowclear', this.isWindowClear());\n    // console.log('totalMessageCount', this.totalMessageCount());\n\n    this.consumePending();\n\n    // if (this.totalMessageCount() < MAX_MESSAGE_COUNT) {\n    //   this.consumePending();\n    // } else if (this.totalMessageCount() >= MAX_MESSAGE_COUNT && this.isWindowClear()) {\n    //   this.garbageCollect();\n    //   // this.tracks.forEach(track => {\n    //   //   track.removeAllChildren();\n    //   // });\n\n    //   // this.emit('update');\n    // }\n  }\n\n  init() {\n    for (let i = 0; i < MAX_TRACKS; i++) {\n      this.tracks[i] = new Track({\n        top: BASE_TOP * i,\n        id: i\n      });\n    }\n  }\n\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/danmu-dom/manager.js","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('div',{attrs:{\"id\":\"app\"}},[_c('div',{staticClass:\"action\",staticStyle:{\"display\":\"flex\"}},[_c('div',{staticClass:\"add\",on:{\"click\":function($event){_vm.addMessageMultiple(15)}}},[_vm._v(_vm._s(_vm.message))]),_vm._v(\" \"),_c('div',{staticClass:\"add\",on:{\"click\":_vm.cleanDanmu}},[_vm._v(\"清除弹幕\")])]),_vm._v(\" \"),_c('div',{staticClass:\"wrap\"},_vm._l((_vm.danmuData),function(item){return _c('div',{key:item.id,staticClass:\"track\"},[_c('transition-group',{attrs:{\"name\":\"left\"},on:{\"leave\":_vm.leave,\"after-leave\":_vm.afterLeave}},_vm._l((item.children),function(message){return _c('div',{key:message.id,ref:\"messages\",refInFor:true,staticClass:\"text\",style:({\n              'animation-duration': message.duration/1000 + 's',\n              fontSize: message.fontSize + 'px',\n            })},[_vm._v(\"\\n            \"+_vm._s(message.content)+\"\\n            \")])}))],1)}))])}\nvar staticRenderFns = []\nvar esExports = { render: render, staticRenderFns: staticRenderFns }\nexport default esExports\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./node_modules/vue-loader/lib/template-compiler?{\"id\":\"data-v-5195536c\",\"hasScoped\":false,\"transformToRequire\":{\"video\":[\"src\",\"poster\"],\"source\":\"src\",\"img\":\"src\",\"image\":\"xlink:href\"},\"buble\":{\"transforms\":{}}}!./node_modules/vue-loader/lib/selector.js?type=template&index=0!./src/App.vue\n// module id = null\n// module chunks = ","function injectStyle (ssrContext) {\n  require(\"!!../node_modules/extract-text-webpack-plugin/dist/loader.js?{\\\"omit\\\":1,\\\"remove\\\":true}!vue-style-loader!css-loader?{\\\"sourceMap\\\":true}!../node_modules/vue-loader/lib/style-compiler/index?{\\\"vue\\\":true,\\\"id\\\":\\\"data-v-5195536c\\\",\\\"scoped\\\":false,\\\"hasInlineConfig\\\":false}!../node_modules/vue-loader/lib/selector?type=styles&index=0!./App.vue\")\n}\nvar normalizeComponent = require(\"!../node_modules/vue-loader/lib/component-normalizer\")\n/* script */\nexport * from \"!!babel-loader!../node_modules/vue-loader/lib/selector?type=script&index=0!./App.vue\"\nimport __vue_script__ from \"!!babel-loader!../node_modules/vue-loader/lib/selector?type=script&index=0!./App.vue\"\n/* template */\nimport __vue_template__ from \"!!../node_modules/vue-loader/lib/template-compiler/index?{\\\"id\\\":\\\"data-v-5195536c\\\",\\\"hasScoped\\\":false,\\\"transformToRequire\\\":{\\\"video\\\":[\\\"src\\\",\\\"poster\\\"],\\\"source\\\":\\\"src\\\",\\\"img\\\":\\\"src\\\",\\\"image\\\":\\\"xlink:href\\\"},\\\"buble\\\":{\\\"transforms\\\":{}}}!../node_modules/vue-loader/lib/selector?type=template&index=0!./App.vue\"\n/* template functional */\nvar __vue_template_functional__ = false\n/* styles */\nvar __vue_styles__ = injectStyle\n/* scopeId */\nvar __vue_scopeId__ = null\n/* moduleIdentifier (server only) */\nvar __vue_module_identifier__ = null\nvar Component = normalizeComponent(\n  __vue_script__,\n  __vue_template__,\n  __vue_template_functional__,\n  __vue_styles__,\n  __vue_scopeId__,\n  __vue_module_identifier__\n)\n\nexport default Component.exports\n\n\n\n//////////////////\n// WEBPACK FOOTER\n// ./src/App.vue\n// module id = null\n// module chunks = ","// The Vue build version to load with the `import` command\n// (runtime-only or standalone) has been set in webpack.base.conf with an alias.\nimport Vue from 'vue'\nimport App from './App'\n\nVue.config.productionTip = false\n\n/* eslint-disable no-new */\nnew Vue({\n  el: '#app',\n  components: { App },\n  template: '<App/>'\n})\n\n\n\n// WEBPACK FOOTER //\n// ./src/main.js"],"sourceRoot":""}